"use strict";$(function(){function i(){$("#panel-message").hide();n.getCombinedFilter()!==undefined&&$("#panel-message").show();$(".dx-button").attr("data-toggle","tooltip");$('[data-toggle="tooltip"]').tooltip()}function r(t){var i="Submission History - ["+t.row.data.fileName+"]",r="/history/"+t.row.data.id;BootstrapDialog.show({size:window.BootstrapDialog.SIZE_WIDE,draggable:!0,closable:!1,title:i,message:$("<div><\/div>").load(r,function(n,t){t==="error"&&toastr.error("Error retrieving history")}),buttons:[{label:"Close",action:function(t){window.assignmentUpdated===!0&&(n.refresh(),window.assignmentUpdated=!1);t.close()}}]})}function u(t,i){var r=i.id;$toggleWorkingButton(t);$.ajax({url:"/api/submission/start/"+r,type:"POST",success:function(t){toastr.success("Started submission process for "+t.fileName+" ("+t.fileNumber+")");n.refresh()},error:function(n){toastr.error("Error starting submission process: "+n.responseJSON.message)},complete:function(){$toggleWorkingButton(t)}})}function f(t,i){var r=i.id;BootstrapDialog.confirm("Cancel Submission, are you sure?",function(t){t&&(window.$showModalWorking(),$.ajax({url:"/api/submission/cancel/"+r,type:"POST",success:function(t){toastr.warning("Cancelled submission process for "+t.fileName+" ("+t.fileNumber+")");n.refresh()},error:function(){toastr.error("Error cancelling submission process")},complete:function(){window.$hideModalWorking()}}))})}function e(t,i){var r="/home/reopen/"+i.id,u="/api/submission/reopen/"+i.id;BootstrapDialog.show({size:window.BootstrapDialog.SIZE_WIDE,draggable:!0,title:"Reopen Reason",message:$("<div><\/div>").load(r,function(n,t){t==="error"&&toastr.error("Error showing history")}),onshown:function(n){var t=n.getButton(n.getButtons()[1].id);t.disable();$(document).on("change","#form",function(){$("#form").validate({rules:{message:{required:!0},nextSubmissionDate:{required:!0}},messages:{message:{required:"Description is required"},nextSubmissionDate:{required:"New Submission Date is required"}},onfocusout:function(n){this.element(n)}});var n=$("#form");n.valid()?t.enable():t.disable()})},buttons:[{label:"Close",action:function(n){n.close()}},{label:"Save",cssClass:"btn-primary",action:function(t){t.enableButtons(!1);t.setClosable(!1);$showModalWorking($(".panel-body"));var i=$("form").serializeJSON();$.ajax({contentType:"application/json;",type:"POST",url:u,data:JSON.stringify(i),dataType:"json",success:function(t){toastr.success("Reopened submission process for "+t.fileName+" ("+t.fileNumber+")");n.refresh()},error:function(n){toastr.error("Error starting submission process: "+n.responseJSON.message)},complete:function(){t.close()}})}}]})}function o(t,i){var r="/home/waiver/"+i.id,u="/api/submission/waive/"+i.id;BootstrapDialog.show({size:window.BootstrapDialog.SIZE_WIDE,draggable:!0,title:"Waiver Reason",message:$("<div><\/div>").load(r,function(n,t){t==="error"&&toastr.error("Error showing history")}),onshown:function(n){var t=n.getButton(n.getButtons()[1].id);t.disable();$(document).on("change","#form",function(){$("#form").validate({rules:{message:{required:!0}},messages:{message:{required:"Description is required"}},onfocusout:function(n){this.element(n)}});var n=$("#form");n.valid()?t.enable():t.disable()})},buttons:[{label:"Close",action:function(n){n.close()}},{label:"Save",cssClass:"btn-primary",action:function(t){t.enableButtons(!1);t.setClosable(!1);$showModalWorking($(".panel-body"));var i=$("form").serializeJSON();$.ajax({contentType:"application/json; charset=utf-8",type:"POST",url:u,data:JSON.stringify(i),success:function(i){toastr.success("Waived submission process for "+i.fileName+" ("+i.fileNumber+")");t.close();n.refresh()},error:function(){toastr.error("Error waiving submission process")},complete:function(){}})}}]})}function s(n,t){var i=["active","success","info","warning","danger"],r=window.moment();if(t.submissionStateDisplay==="Completed"||t.submissionStateDisplay==="Waived"){n.addClass(i[1]);return}if(t.submissionStateDisplay==="CompleteWithErrors"){n.addClass(i[2]);return}if(t.submissionStateDisplay!=="Completed"&&r.isSameOrAfter(t.dueDate)){n.addClass(i[4]);return}if(t.submissionStateDisplay!=="Completed"&&r.add(14,"days").isSameOrAfter(t.dueDate)){n.addClass(i[3]);return}}console.log("submission view ready");window.assignmentUpdated=!1;var t="/api/submission",n=$("#grid").dxDataGrid({dataSource:DevExpress.data.AspNet.createStore({key:"id",loadUrl:t,updateUrl:t}),remoteOperations:!0,allowColumnResizing:!0,allowColumnReordering:!0,showBorders:!0,wordWrapEnabled:!0,"export":{enabled:!0,fileName:"Submissions",allowExportSelectedData:!1,icon:"fa fa-trash"},stateStoring:{enabled:!0,type:"localStorage",storageKey:"gridSubmissionFilterStorage"},filterRow:{visible:!0},headerFilter:{visible:!0},groupPanel:{visible:!0},scrolling:{mode:"virtual",rowRenderingMode:"virtual"},paging:{pageSize:20},height:650,columnResizingMode:"nextColumn",columnMinWidth:50,columnAutoWidth:!0,columnChooser:{enabled:!0},columns:[{alignment:"center",width:100,cellTemplate:function(n,t){$("<a/>").addClass("btn btn-default btn-sm btn-sm-grid").text("Audit").attr("aria-label","submission audit "+t.data.fileName).on("dxclick",function(){console.log(t);r(t)}).appendTo(n)}},{dataField:"fileNumber",caption:"File Number"},{dataField:"fileName",caption:"File Name"},{dataField:"submissionStateDisplay",caption:"Status"},{dataField:"currentAssignment",caption:"Assigned"},{dataField:"lastUpdatedFriendly",caption:"Last Update"},{dataField:"deadlineDate",caption:"Submission Deadline",dataType:"date"},{dataField:"startDate",caption:"Started Date",dataType:"date"},{dataField:"submissionDate",caption:"Date Submitted",dataType:"date"},{dataField:"daysOverdue",caption:"Days Overdue",dataType:"decimal",headerFilter:{dataSource:[{text:"Less than 30",value:["daysOverdue","<",30]},{text:"30 - 90",value:[["daysOverdue",">=",30],["daysOverdue","<",90]]},{text:"90 - 120",value:[["daysOverdue",">=",90],["daysOverdue","<",120]]},{text:"Greater than 120",value:[["daysOverdue",">=",120]]}]}},{dataField:"completionDays",caption:"Completion Days",dataType:"decimal",headerFilter:{dataSource:[{text:"Less than 30",value:["completionDays","<",30]},{text:"30 - 90",value:[["completionDays",">=",30],["completionDays","<",90]]},{text:"90 - 120",value:[["completionDays",">=",90],["completionDays","<",120]]},{text:"Greater than 120",value:[["completionDays",">=",120]]}]}},{dataField:"displayDataYear",caption:"Data Year"},{dataField:"section",caption:"Section",visible:!1},{dataField:"application",caption:"Application",visible:!1},{dataField:"supportGroup",caption:"Support Group",visible:!1},{dataField:"collection",caption:"Collection",visible:!1},{dataField:"isSEA",caption:"SEA",dataType:"boolean",visible:!1,showEditorAlways:!1,trueText:"Yes",falseText:"No",customizeText:function(n){return n.value?"Yes":"No"}},{dataField:"isLEA",caption:"LEA",dataType:"boolean",visible:!1,showEditorAlways:!1,trueText:"Yes",falseText:"No",customizeText:function(n){return n.value?"Yes":"No"}},{dataField:"isSCH",caption:"SCH",dataType:"boolean",visible:!1,showEditorAlways:!1,trueText:"Yes",falseText:"No",customizeText:function(n){return n.value?"Yes":"No"}},{dataField:"generators",caption:"Generators",dataType:"string",visible:!1,cellTemplate:function(n,t){t.data.generators.forEach(function(t){$("<span>"+t+"<\/span><br />").appendTo(n)})},allowFiltering:!1,calculateDisplayValue:function(n){return n.generators.join(", ")}},{dataField:"approvers",caption:"Approvers",dataType:"string",visible:!1,cellTemplate:function(n,t){t.data.approvers.forEach(function(t){$("<span>"+t+"<\/span><br />").appendTo(n)})},allowFiltering:!1,calculateDisplayValue:function(n){return n.approvers.join(", ")}},{dataField:"submitters",caption:"Submitters",dataType:"string",visible:!1,cellTemplate:function(n,t){t.data.submitters.forEach(function(t){$("<span>"+t+"<\/span><br />").appendTo(n)})},allowFiltering:!1,calculateDisplayValue:function(n){return n.submitters.join(", ")}},{width:200,alignment:"center",cellTemplate:function(n,t){t.data.canStart&&$("<a/>").addClass("btn btn-default btn-sm btn-grid").text("Start").attr("aria-label","Start submission "+t.data.fileName).on("dxclick",function(){u($(this),t.data)}).appendTo(n);t.data.canCancel&&$("<a/>").addClass("btn btn-default btn-sm btn-grid").text("Cancel").attr("aria-label","Cancel submission "+t.data.fileName).on("dxclick",function(){f($(this),t.data)}).appendTo(n);t.data.canReview&&$("<a/>").addClass("btn btn-default btn-sm btn-grid").text("Review File").attr("aria-label","Review submission report file").attr("href","/review/"+t.data.dataYear+"/"+t.data.fileNumber).attr("target","_blank").appendTo(n);t.data.canReopen&&$("<a/>").addClass("btn btn-default btn-sm btn-grid").text("Reopen").attr("aria-label","Repopen submission "+t.data.fileName).on("dxclick",function(){e($(this),t.data)}).appendTo(n);t.data.canWaiver&&$("<a/>").addClass("btn btn-default btn-sm btn-grid").text("Waiver").attr("aria-label","Waive submission "+t.data.fileName).on("dxclick",function(){o($(this),t.data)}).appendTo(n)}}],sortByGroupSummaryInfo:[{summaryItem:"count"}],summary:{totalItems:[{column:"fileNumber",displayFormat:"{0} Submissions",summaryType:"count",showInGroupFooter:!0,showInColumn:"FileNumber"}],groupItems:[{summaryType:"count",displayFormat:"{0} Submissions"}]},onRowPrepared:function(n){n.rowType==="data"&&s(n.rowElement,n.data)},onContentReady:function(){i();$(".dx-datagrid-table").addClass("table")},onToolbarPreparing:function(n){var t=n.component;n.toolbarOptions.items.unshift({location:"after",widget:"dxButton",options:{text:"Collapse All",width:136,onClick:function(n){var i=n.component.option("text")==="Expand All";t.option("grouping.autoExpandAll",i);n.component.option("text",i?"Collapse All":"Expand All")}}},{location:"after",widget:"dxButton",options:{icon:"refresh",hint:"Refresh",onClick:function(){t.refresh()}}},{location:"after",widget:"dxButton",options:{icon:"clearformat",hint:"Clear filters",onClick:function(){t.clearFilter()}}},{location:"after",widget:"dxButton",options:{icon:"clearsquare",hint:"Reset grid to default",onClick:function(){t.state({})}}})}}).dxDataGrid("instance")});